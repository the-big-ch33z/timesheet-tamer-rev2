<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>timeflow-grid-manager</title>
    <meta name="description" content="Lovable Generated Project" />
    <meta name="author" content="Lovable" />

    <meta property="og:title" content="timeflow-grid-manager" />
    <meta property="og:description" content="Lovable Generated Project" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
    
    <style>
      .diagnostic-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0f1419;
        color: #ffffff;
        font-family: 'Courier New', monospace;
        padding: 20px;
        overflow-y: auto;
        z-index: 10000;
      }
      .diagnostic-hidden {
        display: none;
      }
      .status-line {
        margin: 8px 0;
        padding: 4px 8px;
        border-radius: 4px;
      }
      .status-success { background: #0d5016; color: #4ade80; }
      .status-error { background: #7f1d1d; color: #f87171; }
      .status-warning { background: #451a03; color: #fbbf24; }
      .status-info { background: #1e3a8a; color: #60a5fa; }
    </style>
  </head>

  <body>
    <!-- Diagnostic Screen -->
    <div id="diagnostic-screen" class="diagnostic-screen">
      <h1 style="color: #60a5fa; margin-bottom: 20px;">üîç ES Module Diagnostic</h1>
      <div id="diagnostic-log"></div>
      <div style="margin-top: 20px;">
        <button id="retry-button" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px;">
          üîÑ Retry Loading
        </button>
        <button id="force-fix-button" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 4px;">
          üõ†Ô∏è Apply Fixes
        </button>
      </div>
    </div>

    <!-- Main app container -->
    <div id="root"></div>

    <!-- Diagnostic Script -->
    <script>
      console.log("=== ES MODULE DIAGNOSTIC START ===");
      
      const diagnosticLog = document.getElementById('diagnostic-log');
      const retryButton = document.getElementById('retry-button');
      const forceFixButton = document.getElementById('force-fix-button');
      let diagnosticResults = {};
      
      function addLog(message, type = 'info') {
        const logLine = document.createElement('div');
        logLine.className = `status-line status-${type}`;
        logLine.textContent = message;
        diagnosticLog.appendChild(logLine);
        console.log(`[${type.toUpperCase()}] ${message}`);
      }
      
      function runDiagnostics() {
        addLog("Starting ES Module diagnostic...", 'info');
        
        // Check 1: Browser ES module support
        try {
          const supportsModules = 'noModule' in HTMLScriptElement.prototype;
          if (supportsModules) {
            addLog("‚úÖ Browser supports ES modules", 'success');
            diagnosticResults.browserSupport = true;
          } else {
            addLog("‚ùå Browser does not support ES modules", 'error');
            diagnosticResults.browserSupport = false;
          }
        } catch (e) {
          addLog("‚ùå Error checking module support: " + e.message, 'error');
          diagnosticResults.browserSupport = false;
        }
        
        // Check 2: Check if we can create module scripts
        try {
          const testScript = document.createElement('script');
          testScript.type = 'module';
          testScript.textContent = 'console.log("Module test");';
          document.head.appendChild(testScript);
          addLog("‚úÖ Can create module scripts", 'success');
          diagnosticResults.moduleCreation = true;
        } catch (e) {
          addLog("‚ùå Cannot create module scripts: " + e.message, 'error');
          diagnosticResults.moduleCreation = false;
        }
        
        // Check 3: Check MIME types and Content-Type
        fetch('/src/main.tsx')
          .then(response => {
            const contentType = response.headers.get('content-type');
            addLog(`Content-Type for main.tsx: ${contentType || 'none'}`, contentType ? 'success' : 'warning');
            diagnosticResults.contentType = contentType;
            return response.text();
          })
          .then(content => {
            addLog(`‚úÖ Can fetch main.tsx (${content.length} characters)`, 'success');
            diagnosticResults.canFetchMain = true;
            
            // Check if content has import statements
            if (content.includes('import ')) {
              addLog("‚úÖ main.tsx contains import statements", 'success');
            } else {
              addLog("‚ö†Ô∏è main.tsx does not contain import statements", 'warning');
            }
          })
          .catch(e => {
            addLog("‚ùå Cannot fetch main.tsx: " + e.message, 'error');
            diagnosticResults.canFetchMain = false;
          });
        
        // Check 4: Vite dev server detection
        if (window.location.port === '8080' || window.location.hostname.includes('localhost')) {
          addLog("‚úÖ Detected development environment", 'success');
          diagnosticResults.devEnvironment = true;
        } else {
          addLog("‚ÑπÔ∏è Production/hosted environment detected", 'info');
          diagnosticResults.devEnvironment = false;
        }
        
        // Check 5: GPT Engineer script
        const gptScript = document.querySelector('script[src*="gptengineer"]');
        if (gptScript) {
          addLog("‚úÖ GPT Engineer script found", 'success');
          diagnosticResults.gptEngineerScript = true;
        } else {
          addLog("‚ùå GPT Engineer script not found", 'error');
          diagnosticResults.gptEngineerScript = false;
        }
        
        // Check 6: CSP headers
        const metaCSP = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
        if (metaCSP) {
          addLog("‚ö†Ô∏è Content Security Policy detected: " + metaCSP.content, 'warning');
          diagnosticResults.csp = metaCSP.content;
        } else {
          addLog("‚úÖ No CSP meta tag found", 'success');
          diagnosticResults.csp = null;
        }
        
        setTimeout(() => {
          addLog("üîç Diagnostic complete. Click 'Apply Fixes' to attempt repairs.", 'info');
        }, 2000);
      }
      
      // Retry button handler
      retryButton.addEventListener('click', () => {
        addLog("üîÑ Retrying module loading...", 'info');
        window.location.reload();
      });
      
      // Force fix button handler
      forceFixButton.addEventListener('click', () => {
        addLog("üõ†Ô∏è Applying fixes...", 'info');
        applyFixes();
      });
      
      function applyFixes() {
        // Fix 1: Remove conflicting scripts
        const allScripts = document.querySelectorAll('script[type="module"]');
        allScripts.forEach(script => {
          if (script.src.includes('main.tsx')) {
            script.remove();
            addLog("üßπ Removed existing main.tsx script", 'info');
          }
        });
        
        // Fix 2: Create new module script with proper attributes
        setTimeout(() => {
          const newScript = document.createElement('script');
          newScript.type = 'module';
          newScript.src = '/src/main.tsx?t=' + Date.now(); // Cache bust
          newScript.crossOrigin = 'anonymous';
          
          newScript.onload = () => {
            addLog("‚úÖ Module loaded successfully!", 'success');
            setTimeout(() => {
              document.getElementById('diagnostic-screen').style.display = 'none';
            }, 2000);
          };
          
          newScript.onerror = (e) => {
            addLog("‚ùå Module loading failed: " + e.message, 'error');
            addLog("üîß Try using the CDN fallback solution", 'warning');
          };
          
          document.head.appendChild(newScript);
          addLog("üì¶ Created new module script with cache busting", 'info');
        }, 1000);
      }
      
      // Start diagnostics
      runDiagnostics();
    </script>

    <!-- IMPORTANT: Keep this for Lovable compatibility -->
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
  </body>
</html>
